<!DOCTYPE html>
<html lang="pt-ao">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Caminho do Saber</title>
  <link rel="stylesheet" href="style.css">
  <script defer>
  // === script integrado ===

  // --- Seleção de Telas ---
  const welcomeScreen = document.getElementById('welcomeScreen');
  const mainScreen = document.getElementById('mainScreen');
  const categorySelectionScreen = document.getElementById('categorySelectionScreen');
  const classSelectionScreen = document.getElementById('classSelectionScreen');
  const gradeSelectionScreen = document.getElementById('gradeSelectionScreen');
  const levelSelectionScreen = document.getElementById('levelSelectionScreen');

  // --- Elementos ---
  const startButton = document.getElementById('startButton');
  const participantNameInput = document.getElementById('participantName');
  const nameErrorDisplay = document.getElementById('nameError');
  const playQuizButton = document.getElementById('playQuizButton');
  const categoryGrid       = document.getElementById('categorySelectionGrid');
  const classGrid          = document.getElementById('classSelectionGrid');
  const gradeGrid          = document.getElementById('gradeSelectionGrid');
  const levelGrid          = document.getElementById('levelSelection');

  // --- Estado ---
  let quizData = {};
  let participantName = '';
  let currentCategory, currentClass, currentGrade, currentLevel;

  // --- Paths ---
  const defaultWelcomeInfoXmlPath = 'data/welcome_info.xml';
  const defaultXmlPath            = 'data/perguntas_padrao.xml';

  // --- Helpers ---
  function showScreen(screen) {
    document.querySelectorAll('.screen').forEach(s => {
      s.classList.remove('active');
      s.classList.add('hidden');
    });
    screen.classList.remove('hidden');
    screen.classList.add('active');
  }
  function shuffleArray(arr) {
    for (let i = arr.length-1; i>0; i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]] = [arr[j],arr[i]];
    }
    return arr;
  }
  function formatCategoryName(name) {
    switch(name) {
      case 'trivium':       return 'Trivium';
      case 'quadrivium':     return 'Quadrivium';
      case 'biblia':         return 'Bíblia';
      case 'cultura_geral':  return 'Cultura Geral';
      case 'cultura_angola': return 'Cultura Angola';
      case 'ingles':         return 'Inglês';
      case 'estudo_meio':    return 'Estudo do Meio';
      case 'kimbundu':       return 'Kimbundu';
      default: return name.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase());
    }
  }

  // --- Parser XML (categoria>classe>grau>nivel name) ---
  function parseQuizXML(xmlString) {
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(xmlString,'application/xml');
    if (xmlDoc.getElementsByTagName('parsererror').length) {
      throw new Error('Erro de sintaxe no XML.');
    }
    const data = {};
    const catNodes = xmlDoc.getElementsByTagName('category');
    if (!catNodes.length) throw new Error('Nenhuma tag <category> encontrada.');
    for (let c of catNodes) {
      const cat = c.getAttribute('name');
      data[cat] = {};
      for (let cl of c.getElementsByTagName('class')) {
        const cls = cl.getAttribute('name');
        data[cat][cls] = {};
        for (let gr of cl.getElementsByTagName('grade')) {
          const grd = gr.getAttribute('name');
          data[cat][cls][grd] = {};
          for (let lv of gr.getElementsByTagName('level')) {
            const lvl = lv.getAttribute('name');
            const key = 'level'+lvl;
            data[cat][cls][grd][key] = [];
            for (let qn of lv.getElementsByTagName('question')) {
              const txtNode = qn.getElementsByTagName('text')[0];
              if (!txtNode) continue;
              const descNode = qn.getElementsByTagName('description')[0];
              const opts = [];
              let corr = 0;
              for (let o of qn.getElementsByTagName('option')) {
                const t = o.textContent.trim();
                const isC = o.getAttribute('correct')==='true';
                if (isC) corr++;
                opts.push({text:t,isCorrect:isC});
              }
              if (opts.length<2 || corr!==1) continue;
              data[cat][cls][grd][key].push({
                question: txtNode.textContent.trim(),
                description: descNode?descNode.textContent.trim():'',
                options: opts
              });
            }
          }
        }
      }
    }
    return data;
  }

  // --- Loaders ---
  async function loadWelcomeInfo(){
    try {
      let res = await fetch(defaultWelcomeInfoXmlPath);
      let xml = await res.text();
      const p = new DOMParser().parseFromString(xml,'application/xml')
                  .getElementsByTagName('welcomeInfo')[0];
      document.getElementById('welcomeTitle').textContent       = p.getElementsByTagName('title')[0]?.textContent || '';
      document.getElementById('welcomeDescription').textContent = p.getElementsByTagName('description')[0]?.textContent || '';
    } catch(e){}
  }

  async function loadDefaultQuizData(){
    const res = await fetch(defaultXmlPath);
    if (!res.ok) throw new Error('Falha ao carregar perguntas');
    const xml = await res.text();
    quizData = parseQuizXML(xml);
  }

  // --- Navegação ---
  function loadQuizCategories(){
    categoryGrid.innerHTML = '';
    for (let cat in quizData) {
      const btn=document.createElement('button');
      btn.className='btn category-btn';
      btn.dataset.category=cat;
      btn.innerHTML=`<h3>${formatCategoryName(cat)}</h3><p>Conteúdo de ${formatCategoryName(cat)}</p>`;
      btn.onclick=()=>{ currentCategory=cat; loadClassButtons(); showScreen(classSelectionScreen); };
      categoryGrid.appendChild(btn);
    }
  }

  function loadClassButtons(){
    classGrid.innerHTML='';
    const classes = ['jardim','1a','2a','3a','4a','5a','6a','7a','8a','9a','10a','11a','12a'];
    classes.forEach(cl=>{
      const b=document.createElement('button');
      b.className='btn category-btn';
      b.dataset.class=cl;
      b.innerHTML=`<h3>${cl.toUpperCase()}</h3>`;
      b.onclick=()=>{ currentClass=cl; showScreen(gradeSelectionScreen); };
      classGrid.appendChild(b);
    });
  }

  gradeGrid.querySelectorAll('button[data-grade]').forEach(b=>{
    b.addEventListener('click', ()=>{
      currentGrade=b.dataset.grade;
      loadLevelsForCategory(currentCategory,currentClass,currentGrade);
      showScreen(levelSelectionScreen);
    });
  });

  function loadLevelsForCategory(cat,cls,grd){
    levelGrid.innerHTML='<h3>Escolha o Nível:</h3>';
    const path = quizData[cat]?.[cls]?.[grd];
    if (!path) { levelGrid.innerHTML+='<p>Níveis não encontrados.</p>'; return;}
    Object.keys(path).sort((a,b)=>parseInt(a.replace('level',''))-parseInt(b.replace('level','')))
      .forEach(lv=>{
        const btn=document.createElement('button');
        btn.className='btn level-btn';
        btn.dataset.level=lv;
        btn.textContent=`Nível ${lv.replace('level','')}`;
        btn.onclick=()=>{ currentLevel=lv; /*startQuiz(cat,cls,grd,lv)*/ };
        levelGrid.appendChild(btn);
      });
  }

  // --- Botões ---
  startButton.addEventListener('click', async ()=>{
    const name = participantNameInput.value.trim();
    if (name.length<2){
      nameErrorDisplay.textContent="Por favor, digite um nome válido (mínimo 2 caracteres).";
      participantNameInput.focus();
      return;
    }
    nameErrorDisplay.textContent='';
    participantName=name;
    localStorage.setItem('participantName',participantName);
    if (!Object.keys(quizData).length) await loadDefaultQuizData();
    showScreen(mainScreen);
  });

  playQuizButton.addEventListener('click', ()=>{
    if (!Object.keys(quizData).length){
      alert("Perguntas não carregadas!");
      return;
    }
    loadQuizCategories();
    showScreen(categorySelectionScreen);
  });

  // --- Inicialização ---
  document.addEventListener('DOMContentLoaded', ()=>{
    loadWelcomeInfo();
    loadDefaultQuizData().catch(console.error);
    const saved=localStorage.getItem('participantName');
    if (saved){
      participantNameInput.value = saved;
      participantName = saved;
    }
  });

  </script>
</head>
<body>
  <main>
    <!-- 1) Boas-vindas -->
    <section id="welcomeScreen" class="screen active" role="region" aria-labelledby="welcomeTitle">
      <div class="welcome-container">
        <h1 id="welcomeTitle">Bem-vindo ao Caminho do Saber</h1>
        <p id="welcomeDescription">Um quiz divertido e educativo!</p>
        <div class="name-input-container">
          <label for="participantName">Seu Nome:</label>
          <input type="text" id="participantName" placeholder="Digite seu nome" minlength="2" maxlength="20" aria-required="true">
          <p id="nameError" class="feedback-message incorrect"></p>
        </div>
        <button id="startButton" class="btn primary-btn">Iniciar Quiz</button>
      </div>
    </section>

    <!-- 2) Menu Principal -->
    <section id="mainScreen" class="screen hidden" role="region" aria-labelledby="mainMenuTitle">
      <div class="main-container">
        <h1 id="mainMenuTitle">Menu Principal</h1>
        <button id="playQuizButton" class="btn primary-btn">Jogar Quiz</button>
        <button id="learnModeButton" class="btn secondary-btn">Vamos Aprender</button>
      </div>
    </section>

    <!-- 3) Seleção de Categoria -->
    <section id="categorySelectionScreen" class="screen hidden" role="region" aria-labelledby="categoryTitleHeading">
      <div class="category-selection-container">
        <h1 id="categoryTitleHeading">Escolha a Categoria</h1>
        <div id="categorySelectionGrid" class="category-grid"></div>
        <button id="backToMainMenuFromCategories" class="btn secondary-btn">Voltar</button>
      </div>
    </section>

    <!-- 4) Seleção de Classe -->
    <section id="classSelectionScreen" class="screen hidden" role="region" aria-labelledby="classSelectionTitle">
      <div class="content-container">
        <h1 id="classSelectionTitle">Escolha a Classe</h1>
        <div id="classSelectionGrid" class="category-grid"></div>
        <button id="backToCategorySelectionFromClass" class="btn secondary-btn">Voltar</button>
      </div>
    </section>

    <!-- 5) Seleção de Grau -->
    <section id="gradeSelectionScreen" class="screen hidden" role="region" aria-labelledby="gradeSelectionTitle">
      <div class="content-container">
        <h1 id="gradeSelectionTitle">Escolha o Grau</h1>
        <div id="gradeSelectionGrid" class="category-grid">
          <button class="btn category-btn" data-grade="basico">Básico</button>
          <button class="btn category-btn" data-grade="medio">Médio</button>
          <button class="btn category-btn" data-grade="avancado">Avançado</button>
        </div>
        <button id="backToClassSelectionFromGrade" class="btn secondary-btn">Voltar</button>
      </div>
    </section>

    <!-- 6) Seleção de Nível -->
    <section id="levelSelectionScreen" class="screen hidden" role="region" aria-labelledby="levelCategoryTitle">
      <div class="level-selection-container">
        <h2 id="levelCategoryTitle"></h2>
        <div id="levelSelection" class="level-selection-grid"></div>
        <button id="backToGradeSelectionFromLevel" class="btn secondary-btn">Voltar</button>
      </div>
    </section>

    <!-- Nota: adicione aqui as seções questionScreen, resultScreen, historyScreen, etc., conforme necessidade -->

  </main>
</body>
</html>
