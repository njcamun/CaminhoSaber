<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Atualizar Perguntas (Protegido)</title>
  <!-- 2) Estilo global (estrutura e layout) -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* -------- Estilo m√≠nimo para a p√°gina -------- */
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
      color: #333;
    }
    .container {
      max-width: 800px;
      margin: 60px auto 20px auto;
      background: rgba(255, 255, 255, 0.85);
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      padding: 20px;
	  text-align: center;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    label {
      font-weight: bold;
    }
    select,
    input[type="text"],
    textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #bbb;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .opcao-resposta {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .opcao-resposta input[type="text"] {
      flex: 1;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
      color: #fff;
    }
    button#adicionarBtn {
      background-color: #28a745;
    }
    button#exportarBtn {
      background-color: #007bff;
      margin-top: 20px;
    }
    #status {
      margin-top: 10px;
      font-style: italic;
      color: #555;
    }
    pre {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 300px;
    }

    /* -------- Modal de senha -------- */
    #senhaModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    #senhaModal .modal-content {
      background: rgba(255, 255, 255, 0.2);
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      width: 320px;
    }
    #senhaModal h2 {
      margin-top: 0;
      text-align: center;
    }
    #senhaModal input[type="password"] {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    #senhaModal button {
      width: 100%;
      padding: 10px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    #senhaModal #senhaMsg {
      color: red;
      font-size: 0.9em;
      text-align: center;
      margin-top: 8px;
      display: none;
    }

    /* -------- Bot√£o Voltar -------- */
    #backToQuizBtn {
      background-color: #6c757d;
      margin-bottom: 20px;
    }
    #backToQuizBtn i {
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <!-- *************** Modal de Login (senha) *************** -->
  <div id="senhaModal">
    <div class="modal-content">
      <h2>Digite a senha</h2>
      <input id="senhaInput" type="password" placeholder="Senha" />
      <button id="senhaOkBtn">OK</button>
      <p id="senhaMsg">Senha incorreta!</p>
    </div>
  </div>

  <div id="content" style="display: none;">
    <div class="container">
      <!-- Bot√£o Voltar ao Quiz (index.html) -->
      
      <h1>Adicionar Pergunta ao Quiz</h1>
      <form id="perguntaForm">
        <!-- 1) Sele√ß√£o de Categoria -->
        <div>
          <label for="categoriaSelect">Categoria:</label>
          <select id="categoriaSelect" required>
            <option value="" disabled selected>‚Äî Selecione a categoria ‚Äî</option>
            <option value="trivium">Trivium</option>
            <option value="quadrivium">Quadrivium</option>
            <option value="bible">B√≠blia</option>
            <option value="generalCulture">Cultura Geral Universal</option>
            <option value="mwangole">Mwangole</option>
            <option value="english">Ingl√™s</option>
            <option value="kimbundu">Kimbundu</option>
            <option value="environment">Estudo do Meio</option>
            <option value="misturaTudo">Mistura Tudo</option>
          </select>
        </div>
        <!-- 2) Sele√ß√£o de Classe -->
        <div>
          <label for="classeSelect">Classe:</label>
          <select id="classeSelect" required>
            <option value="" disabled selected>‚Äî Selecione a classe ‚Äî</option>
            <option value="primaria">Prim√°ria</option>
            <option value="secundaria">Secund√°ria</option>
            <option value="medio">M√©dio</option>
          </select>
        </div>
        <!-- 3) Sele√ß√£o de Grau -->
        <div>
          <label for="grauSelect">Grau:</label>
          <select id="grauSelect" required>
            <option value="" disabled selected>‚Äî Selecione o grau ‚Äî</option>
            <option value="basico">B√°sico</option>
            <option value="intermedio">Intermedi√°rio</option>
            <option value="avancado">Avan√ßado</option>
          </select>
        </div>
        <!-- 4) Texto da Pergunta -->
        <div>
          <label for="textoPergunta">Pergunta:</label>
          <textarea id="textoPergunta" rows="2" placeholder="Digite o enunciado da pergunta" required></textarea>
        </div>
        <!-- 5) Descri√ß√£o (explica√ß√£o extra) -->
        <div>
          <label for="descricaoPergunta">Descri√ß√£o (explica√ß√£o / dica):</label>
          <textarea id="descricaoPergunta" rows="2" placeholder="Ex.: Explica√ß√£o sobre a resposta correta" required></textarea>
        </div>
        <!-- 6) 4 Op√ß√µes de Resposta + Checkbox para marcar a correta -->
        <div>
          <label>Op√ß√µes de Resposta (marque a correta):</label>
          <div class="opcao-resposta">
            <input type="text" class="respostaTexto" placeholder="Op√ß√£o 1" required />
            <input type="checkbox" class="respostaCorreta" /><span>Correta?</span>
          </div>
          <div class="opcao-resposta">
            <input type="text" class="respostaTexto" placeholder="Op√ß√£o 2" required />
            <input type="checkbox" class="respostaCorreta" /><span>Correta?</span>
          </div>
          <div class="opcao-resposta">
            <input type="text" class="respostaTexto" placeholder="Op√ß√£o 3" required />
            <input type="checkbox" class="respostaCorreta" /><span>Correta?</span>
          </div>
          <div class="opcao-resposta">
            <input type="text" class="respostaTexto" placeholder="Op√ß√£o 4" required />
            <input type="checkbox" class="respostaCorreta" /><span>Correta?</span>
          </div>
        </div>
        <!-- Bot√£o de adicionar pergunta -->
        <button type="button" id="adicionarBtn">‚ûï Adicionar Pergunta</button>
      </form>
      <div id="status">Nenhuma pergunta ainda.</div>
      <!-- Bot√£o para gerar/baixar XML -->
      <button type="button" id="exportarBtn">üíæ Exportar XML</button>
	  <button id="backToQuizBtn">
        <i class="fa-solid fa-arrow-left"></i> Voltar ao Quiz
      </button>
      <!-- √Årea para visualizar o XML gerado (opcional) -->
      <h2>Pr√©via do XML</h2>
      <pre id="xmlPreview">&lt;-- Aqui aparecer√° o XML gerado --&gt;</pre>
    </div>
  </div>

  <script>
    // ***************** Valida√ß√£o de Senha via Modal *****************
    window.addEventListener('DOMContentLoaded', () => {
      const modal      = document.getElementById('senhaModal');
      const inputSenha = document.getElementById('senhaInput');
      const btnOk      = document.getElementById('senhaOkBtn');
      const msgErro    = document.getElementById('senhaMsg');
      const content    = document.getElementById('content');
      const backBtn    = document.getElementById('backToQuizBtn');

      // Esconde o conte√∫do at√© validar a senha
      content.style.display = 'none';

      // Se a senha estiver errada, volta para index.html
      btnOk.addEventListener('click', () => {
        const valor = inputSenha.value.trim();
        if (valor === '123456789') {
          modal.style.display = 'none';
          content.style.display = 'block';
        } else {
          window.location.href = 'index.html';
        }
      });

      // Bot√£o ‚ÄúVoltar ao Quiz‚Äù ‚Üí leva para index.html
      backBtn.addEventListener('click', () => {
        window.location.href = 'index.html';
      });

      inputSenha.focus();
    });

    // --- Estruturas em Mem√≥ria para as Perguntas ---
    const todasPerguntas    = [];
    const contaPerguntas    = {};

    const selectCategoria    = document.getElementById('categoriaSelect');
    const selectClasse       = document.getElementById('classeSelect');
    const selectGrau         = document.getElementById('grauSelect');
    const txtPergunta        = document.getElementById('textoPergunta');
    const txtDescricao       = document.getElementById('descricaoPergunta');
    const btnAdicionar       = document.getElementById('adicionarBtn');
    const statusDiv          = document.getElementById('status');
    const btnExportar        = document.getElementById('exportarBtn');
    const xmlPreview         = document.getElementById('xmlPreview');

    btnAdicionar.addEventListener('click', () => {
      const categoria = selectCategoria.value;
      const classe    = selectClasse.value;
      const grau      = selectGrau.value;
      const qText     = txtPergunta.value.trim();
      const qDesc     = txtDescricao.value.trim();

      const respostasTextoEls   = document.querySelectorAll('.respostaTexto');
      const respostasCorretaEls = document.querySelectorAll('.respostaCorreta');

      if (!categoria || !classe || !grau) {
        alert('Selecione Categoria, Classe e Grau antes de adicionar.');
        return;
      }
      if (!qText) {
        alert('Digite o texto da pergunta.');
        return;
      }
      if (!qDesc) {
        alert('Digite a descri√ß√£o (explica√ß√£o).');
        return;
      }

      let numCorretas = 0;
      respostasCorretaEls.forEach(cb => { if (cb.checked) numCorretas++; });
      if (numCorretas !== 1) {
        alert('Marque exatamente UMA op√ß√£o como correta.');
        return;
      }

      const opcoes = [];
      for (let i = 0; i < 4; i++) {
        const texto = respostasTextoEls[i].value.trim();
        const isCorrect = respostasCorretaEls[i].checked;
        if (!texto) {
          alert(`Preencha o texto da op√ß√£o ${i + 1}.`);
          return;
        }
        opcoes.push({ text: texto, correct: isCorrect });
      }

      if (!contaPerguntas[categoria]) contaPerguntas[categoria] = {};
      if (!contaPerguntas[categoria][classe]) contaPerguntas[categoria][classe] = {};
      if (!contaPerguntas[categoria][classe][grau]) contaPerguntas[categoria][classe][grau] = 0;

      let totalParaEsteGrupo = ++contaPerguntas[categoria][classe][grau];
      const nivelAtual = Math.floor((totalParaEsteGrupo - 1) / 15) + 1;

      todasPerguntas.push({
        category:    categoria,
        classe:      classe,
        grau:        grau,
        level:       nivelAtual,
        question:    qText,
        description: qDesc,
        options:     opcoes
      });

      // Limpar campos
      txtPergunta.value = '';
      txtDescricao.value = '';
      respostasTextoEls.forEach(inp => inp.value = '');
      respostasCorretaEls.forEach(cb => cb.checked = false);

      statusDiv.textContent =
        `${todasPerguntas.length} pergunta(s) adicionada(s).` +
        ` (√öltimo: Categoria=${categoria}, Classe=${classe}, Grau=${grau}, N√≠vel=${nivelAtual})`;
    });

    btnExportar.addEventListener('click', () => {
      if (todasPerguntas.length === 0) {
        alert('Nenhuma pergunta foi adicionada ainda!');
        return;
      }

      const dataEstruturada = {};
      todasPerguntas.forEach(p => {
        if (!dataEstruturada[p.category]) {
          dataEstruturada[p.category] = {};
        }
        if (!dataEstruturada[p.category][p.classe]) {
          dataEstruturada[p.category][p.classe] = {};
        }
        if (!dataEstruturada[p.category][p.classe][p.grau]) {
          dataEstruturada[p.category][p.classe][p.grau] = {};
        }
        if (!dataEstruturada[p.category][p.classe][p.grau][p.level]) {
          dataEstruturada[p.category][p.classe][p.grau][p.level] = [];
        }
        dataEstruturada[p.category][p.classe][p.grau][p.level].push({
          question:    p.question,
          description: p.description,
          options:     p.options
        });
      });

      let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<quiz>\n`;
      for (const catName in dataEstruturada) {
        xml += `  <category name="${catName}">\n`;

        for (const clsName in dataEstruturada[catName]) {
          xml += `    <class name="${clsName}">\n`;

          for (const grauName in dataEstruturada[catName][clsName]) {
            xml += `      <grade name="${grauName}">\n`;

            const niveisObj = dataEstruturada[catName][clsName][grauName];
            const niveisOrdenados = Object.keys(niveisObj)
                                         .map(n => parseInt(n))
                                         .sort((a,b) => a - b);

            niveisOrdenados.forEach(lvNum => {
              const perguntasDoNivel = niveisObj[lvNum];
              xml += `        <level name="${lvNum}">\n`;
              perguntasDoNivel.forEach(perg => {
                xml += `          <question>\n`;
                xml += `            <text>${escapeXml(perg.question)}</text>\n`;
                xml += `            <description>${escapeXml(perg.description)}</description>\n`;
                perg.options.forEach(opt => {
                  xml += `            <option correct="${opt.correct}">${escapeXml(opt.text)}</option>\n`;
                });
                xml += `          </question>\n`;
              });
              xml += `        </level>\n`;
            });

            xml += `      </grade>\n`;
          }
          xml += `    </class>\n`;
        }
        xml += `  </category>\n`;
      }
      xml += `</quiz>`;

      xmlPreview.textContent = xml;

      const blob = new Blob([xml], { type: 'application/xml' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'perguntas_geradas.xml';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Fun√ß√£o auxiliar para escapar caracteres especiais em XML
    function escapeXml(unsafe) {
      return unsafe.replace(/[<>&'"]/g, c => {
        switch (c) {
          case '<': return '&lt;';
          case '>': return '&gt;';
          case '&': return '&amp;';
          case "'": return '&apos;';
          case '"': return '&quot;';
        }
      });
    }
  </script>
</body>
</html>
